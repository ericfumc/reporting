<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ICCR Report Generator</title>
<style>
:root{--bg:#0f1724;--card:#0b1220;--muted:#94a3b8;--accent:#06b6d4;--mono:"Courier New",Courier,monospace}
html,body{height:100%;margin:0;font-family:Inter, system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,#071025 0%,#07142b 100%);color:#e6eef6}
.wrap{max-width:1100px;margin:24px auto;padding:20px}
header{display:flex;gap:16px;align-items:center;margin-bottom:18px}
h1{margin:0;font-size:20px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
select,input,textarea,button{font-family:inherit}
.grid{display:grid;grid-template-columns:320px 1fr;gap:12px;margin-top:12px}
.left{padding-right:8px}
.field-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
label{width:46%;font-size:13px;color:var(--muted)}
input[type="text"],select{flex:1;padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
textarea#preview{width:100%;height:420px;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:#011024;color:#dff3fb;font-family:var(--mono);font-size:13px;white-space:pre;overflow:auto}
button{background:var(--accent);color:#002;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
button.secondary{background:transparent;color:var(--accent);border:1px solid rgba(255,255,255,0.04)}
.category-title{font-weight:600;color:#eaf8fb;margin-top:10px;margin-bottom:6px}
.fields-box{max-height:320px;overflow:auto;padding-right:6px}
.small{font-size:12px;color:var(--muted);margin-top:6px}

/* Light theme */
body.light-theme {
  --bg: #f8f9fa;
  --card: #ffffff;
  --muted: #6c757d;
  --accent: #0d6efd;
  --mono: "Courier New", Courier, monospace;
  color: #212529;
}
body.light-theme textarea#preview { background: #f0f0f0; color: #212529; }
body.light-theme input, body.light-theme select { background: #ffffff; color: #212529; border: 1px solid #ced4da; }
</style>
</head>
<body>
<div class="wrap">
<header style="align-items:center">
<h1>ICCR Report Generator</h1>
<div style="margin-left:auto">
  <button id="themeToggle" class="secondary small">Toggle Theme</button>
</div>
</header>

<div class="card">
<div style="display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px;">
<div>
<label for="templateSelect" class="small">Template</label><br>
<select id="templateSelect"></select>
</div>
<div>
<label class="small">Diagnosis (optional)</label><br>
<input id="diagnosis" type="text" placeholder="Final diagnosis line (optional)" style="width:420px"/>
</div>
</div>

<div class="grid">
<div class="left">
<div class="card" style="padding:12px;">
<div style="font-weight:600;margin-bottom:6px">Fields</div>
<div class="fields-box" id="fieldsBox"></div>
</div>
</div>

<div>
<div class="card" style="padding:12px">
<div style="display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:6px">
<div style="font-weight:600">Report Preview</div>
<div style="display:flex;gap:8px">
<button id="btnCopy">Copy</button>
<button id="btnDownload" class="secondary">Download .txt</button>
</div>
</div>
<textarea id="preview" readonly></textarea>
<div style="display:flex;gap:8px;margin-top:8px">
<button id="btnReset" class="secondary">Reset values</button>
</div>
</div>
</div>
</div>
</div>
</div>

<script>
// Template JSON files
const templateFiles = [
  { key: "breast", filename: "templates/breast.json" },
  { key: "colorectal", filename: "templates/colorectal.json" },
  { key: "endometrium", filename: "templates/endometrium.json" }
];

let templates = {}, currentTemplateKey, fieldInputs = {};
const maxFieldLen=36, wrapWidth=72, separator=":";

const templateSelect = document.getElementById('templateSelect');
const fieldsBox = document.getElementById('fieldsBox');
const preview = document.getElementById('preview');
const btnCopy = document.getElementById('btnCopy');
const btnDownload = document.getElementById('btnDownload');
const btnReset = document.getElementById('btnReset');
const diagnosisInput = document.getElementById('diagnosis');
const themeToggle = document.getElementById('themeToggle');

// Load JSON templates dynamically
async function loadTemplates(){
  for(const t of templateFiles){
    try{
      const resp = await fetch(t.filename);
      if(!resp.ok) throw new Error("Failed to fetch "+t.filename);
      templates[t.key] = await resp.json();
    } catch(e){ console.error("Error loading template", t.key, e); }
  }
  currentTemplateKey = Object.keys(templates)[0];
  if(localStorage.getItem('theme')==='light') document.body.classList.add('light-theme');
  populateTemplateSelect(); buildFieldsUI(currentTemplateKey);
}

// Populate template dropdown
function populateTemplateSelect(){
  templateSelect.innerHTML='';
  for(const k in templates){
    const opt=document.createElement('option'); opt.value=k; opt.textContent=templates[k].templateName;
    templateSelect.appendChild(opt);
  }
  templateSelect.value=currentTemplateKey;
}

// Build input fields UI
function buildFieldsUI(templateKey){
  fieldsBox.innerHTML=''; fieldInputs={};
  const tpl = templates[templateKey];
  tpl.categories.forEach(cat=>{
    const title=document.createElement('div'); title.className='category-title'; title.textContent=cat.name;
    fieldsBox.appendChild(title);
    cat.fields.forEach(f=>{
      const row=document.createElement('div'); row.className='field-row';
      const lbl=document.createElement('label'); lbl.textContent=f.label;

      let input;
      if(f.options && Array.isArray(f.options)){
        input=document.createElement('select');
        const blankOpt=document.createElement('option'); blankOpt.value=''; blankOpt.textContent='-- Select --'; input.appendChild(blankOpt);
        f.options.forEach(opt=>{ const o=document.createElement('option'); o.value=opt; o.textContent=opt; input.appendChild(o); });
        input.addEventListener('change', updatePreview);
      } else {
        input=document.createElement('input'); input.type='text';
        input.addEventListener('input', updatePreview);
        input.addEventListener('keydown', ev=>{ if(ev.key==='Enter'){ ev.preventDefault(); focusNextInput(input); } });
      }

      input.dataset.label=f.label; row.appendChild(lbl); row.appendChild(input); fieldsBox.appendChild(row);
      fieldInputs[f.label]=input;
    });
  });

  diagnosisInput.addEventListener('input', updatePreview);

  updatePreview();
}

// Focus next input
function focusNextInput(el){
  const keys=Object.keys(fieldInputs);
  const idx=keys.indexOf(el.dataset.label);
  if(idx>=0 && idx<keys.length-1) fieldInputs[keys[idx+1]].focus();
  else diagnosisInput.focus();
}

// Wrap text with indent
function wrapText(value,maxLen,indent){
  if(!value) return '';
  const words=value.split(/\s+/); const prefix=' '.repeat(indent); let line='',out='';
  for(let w of words){
    if(line.length===0) line=w;
    else if(line.length+1+w.length>maxLen){ out+=(out?'\n'+prefix:'')+line; line=w; }
    else line+=' '+w;
  }
  if(line) out+=(out?'\n'+prefix:'')+line;
  return out;
}

// Build ICCR report
function buildReport(templateKey){
  const tpl=templates[templateKey]; const diag=(diagnosisInput.value||'').trim();
  let report=''; const indent=maxFieldLen+separator.length;
  if(diag) report += 'FINAL DIAGNOSIS\n'+ '-'.repeat(15)+'\n'+diag+'\n\n';
  tpl.categories.forEach(cat=>{
    const catLines=[];
    cat.fields.forEach(f=>{
      const v=(fieldInputs[f.label].value||'').trim();
      if(!v) return; const low=v.toLowerCase(); if(['n/a','not applicable','none','nil'].includes(low)) return;
      const padded=(f.label+' '.repeat(maxFieldLen)).slice(0,maxFieldLen);
      const wrappedValue=wrapText(v,wrapWidth,indent);
      const firstLineIndex=wrappedValue.indexOf('\n');
      if(firstLineIndex===-1) catLines.push(padded+separator+wrappedValue);
      else { const first=wrappedValue.slice(0,firstLineIndex); const rest=wrappedValue.slice(firstLineIndex+1);
        catLines.push(padded+separator+first); catLines.push(rest);
      }
    });
    if(catLines.length) report+=cat.name.toUpperCase()+'\n'+ '-'.repeat(80)+'\n'+catLines.join('\n')+'\n\n';
  });
  return report.replace(/\s+$/,'');
}

// Update preview in real-time
function updatePreview(){ preview.value=buildReport(currentTemplateKey); }

// Event listeners
templateSelect.addEventListener('change',()=>{ currentTemplateKey=templateSelect.value; buildFieldsUI(currentTemplateKey); });
btnCopy.addEventListener('click', async()=>{
  const text=buildReport(currentTemplateKey);
  try{ await navigator.clipboard.writeText(text); alert('Report copied to clipboard'); }
  catch(e){ alert('Copy failed'); }
});
btnDownload.addEventListener('click',()=>{
  const text=buildReport(currentTemplateKey);
  const filename=templates[currentTemplateKey].templateName.replace(/\s+/g,'_')+"_Report.txt";
  const blob=new Blob([text],{type:'text/plain'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
btnReset.addEventListener('click',()=>{ Object.values(fieldInputs).forEach(inp=>inp.value=''); diagnosisInput.value=''; updatePreview(); });
themeToggle.addEventListener('click',()=>{
  document.body.classList.toggle('light-theme');
  localStorage.setItem('theme', document.body.classList.contains('light-theme')?'light':'dark');
});

// Initialize
loadTemplates();
</script>
</body>
</html>
