<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Synoptic Report based on CAP protocol by Eric Fu</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; padding:20px; color:#111}
    .container{max-width:900px;margin:0 auto}
    label{font-weight:600;display:block;margin-top:12px}
    textarea{width:100%;min-height:160px;font-family:monospace;font-size: 16px;padding:10px;border:1px solid #ccc;box-sizing:border-box}
    pre{white-space:pre-wrap;background:#f7f7f7;padding:12px;border:1px solid #ddd;min-height:200px}
    .row{display:flex;gap:8px;margin-top:8px;align-items:center}
    select,input[type="text"]{padding:8px;border:1px solid #ccc;border-radius:4px}
    button{padding:8px 12px;border:1px solid #111;background:#fff;cursor:pointer}
    .muted{color:#666;font-size:0.9rem}
  </style>
</head>
<body>
  <div class="container">
    <h2>Synoptic Report based on CAP protocol</h2>
    
    <input id="csvUrl" type="hidden" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vRIMyFywb76pgt3-m-p97o6y-Qul9HWgxX7V_0W7nvgCc1z5ogWejCUGRj0SlFzER9Gtk3DTJcqSiPv/pub?output=csv">

    <div class="row">
      <button id="loadCsv">Load templates</button>
      <span class="muted">or just paste your report manually below</span>
    </div>

<label for="templateSelect">Choose Template</label>
<select id="templateSelect"><option value="">-- none --</option></select>
<p><a id="templateLink" href="#" target="_blank" style="display:none; font-size:0.9rem;">View template reference</a></p>

    <label for="inputText">Unformatted Report Input</label>
    <textarea id="inputText" placeholder="The format required is as follows:&#10;Histological type: Adenocarcinoma&#10;Tumour extent: Invades submucosa"></textarea>

    <div id="pdfContainer" style="display:none; width:100%; height:400px; border:1px solid #ccc; margin-top:1rem;">
      <iframe id="pdfViewer" src="" width="100%" height="100%" style="border:none;"></iframe>
    </div>
    
    <div class="row">
      <button id="formatBtn">Format Report</button>
      <button id="copyBtn">Copy to clipboard</button>
      <button id="downloadBtn">Download .txt</button>
    </div>

    <label>Formatted Report</label>
    <pre id="output" aria-live="polite"></pre>

    <p class="muted">Created by Eric Fu.</p>
  </div>

<script>
/* ---------- CSV parser that handles quoted fields with embedded newlines ----------
   Returns array of rows; each row is array of cell strings.
   Lightweight, robust for Google Sheets CSV.
*/
function parseCSV(text){
  const rows = [];
  let i = 0, len = text.length;
  let row = [], cell = '', inQuotes = false;

  while(i < len){
    const ch = text[i];
    if(inQuotes){
      if(ch === '"'){
        if(text[i+1] === '"'){ cell += '"'; i += 2; continue; } // escaped quote
        else { inQuotes = false; i++; continue; }
      } else {
        cell += ch;
        i++;
        continue;
      }
    } else {
      if(ch === '"'){ inQuotes = true; i++; continue; }
      if(ch === ','){ row.push(cell); cell = ''; i++; continue; }
      if(ch === '\r'){ i++; continue; }
      if(ch === '\n'){ row.push(cell); rows.push(row); row = []; cell = ''; i++; continue; }
      cell += ch; i++;
    }
  }
  // push last
  if(inQuotes === false){
    if(cell !== '' || row.length > 0){ row.push(cell); rows.push(row); }
  }
  return rows;
}

/* ----------------- Format logic -----------------
   - lines with ":" are parsed as key:value
   - key + ":" left, datum starts at column 41 (index 40 zero-based)
   - wrap value lines at 80 chars, don't break words
*/
function wrapWords(text, maxWidth){
  if(!text) return [];
  const words = text.split(/\s+/);
  const lines = [];
  let cur = '';
  for(const w of words){
    if((cur.length ? cur.length + 1 + w.length : w.length) > maxWidth){
      if(cur) lines.push(cur);
      cur = w;
    } else {
      cur = cur ? (cur + ' ' + w) : w;
    }
  }
  if(cur) lines.push(cur);
  return lines;
}

function formatReportFromInput(inputText){
  const inLines = inputText.split(/\r?\n/);
  const indent = 40; // datum starts at column 41 (so 40 spaces)
  const maxTotal = 80;
  const valueWidth = maxTotal - indent;
  const outLines = [];

  for(const rawLine of inLines){
    // preserve empty lines
    if(rawLine.trim() === ''){ outLines.push(''); continue; }

    if(rawLine.indexOf(':') === -1){
      // no colon â€” keep line as is
      outLines.push(rawLine);
      continue;
    }

    // split at first colon
    const idx = rawLine.indexOf(':');
    const key = rawLine.slice(0, idx).trim();
    const value = rawLine.slice(idx+1).trim();

    const keyPart = key + ':';
    const padLen = Math.max(indent - keyPart.length, 1);
    const pad = ' '.repeat(padLen);

    // wrap the value to valueWidth characters, not splitting words
    const vlines = wrapWords(value, valueWidth);
    if(vlines.length === 0){
      outLines.push(keyPart + pad);
    } else {
      outLines.push(keyPart + pad + vlines[0]);
      for(let i=1;i<vlines.length;i++){
        outLines.push(' '.repeat(indent) + vlines[i]);
      }
    }
  }

  return outLines.join('\n');
}

/* ----------------- UI wiring ----------------- */
const csvInput = document.getElementById('csvUrl');
const loadCsvBtn = document.getElementById('loadCsv');
const templateSelect = document.getElementById('templateSelect');
const inputText = document.getElementById('inputText');
const formatBtn = document.getElementById('formatBtn');
const outputEl = document.getElementById('output');
const copyBtn = document.getElementById('copyBtn');
const downloadBtn = document.getElementById('downloadBtn');

// populate dropdown from rows (name, body, link)
function populateTemplates(rows) {
  templateSelect.innerHTML = '<option value="">-- none --</option>';
  const templates = [];
  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];
    const name = (r[0] || '').toString().trim();
    const body = (r[1] || '').toString();
    const link = (r[2] || '').toString().trim();
    if (name) {
      const opt = document.createElement('option');
      opt.value = templates.length;
      opt.textContent = name;
      templateSelect.appendChild(opt);
      templates.push({ name, body, link });
    }
  }
  templateSelect._templates = templates;
}


// fetch CSV and populate
async function fetchAndLoadCSV(url){
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error('Fetch failed: ' + res.status);
    const text = await res.text();
    const rows = parseCSV(text);
    populateTemplates(rows);
  } catch(err){
    console.error(err);
    alert('Failed to load template: ' + err.message + '\nYou can still paste templates manually.');
  }
}

// events
loadCsvBtn.addEventListener('click', ()=>{
  const url = csvInput.value.trim();
  if(!url){ alert('Paste the published CSV URL into the field above, then click Load templates.'); return; }
  fetchAndLoadCSV(url);
});

// When user selects a template
templateSelect.addEventListener('change', async () => {
  const idx = templateSelect.value;
  const linkEl = document.getElementById('templateLink');
  const pdfContainer = document.getElementById('pdfContainer');
  const pdfViewer = document.getElementById('pdfViewer');
  const templates = templateSelect._templates || [];

  // Reset UI
  inputText.value = '';
  linkEl.style.display = 'none';
  pdfContainer.style.display = 'none';
  pdfViewer.src = '';

  if (idx === '') return;

  const tpl = templates[Number(idx)];
  if (!tpl) return;

  // Fill text
  inputText.value = tpl.body;

  // Check link validity
  if (tpl.link && /^https?:\/\//i.test(tpl.link)) {
    let pdfUrl = tpl.link.trim();

    // --- Google Drive link conversion ---
    if (pdfUrl.includes('drive.google.com')) {
      alert(pdfUrl);
      const match = pdfUrl.match(/\/d\/([a-zA-Z0-9_-]+)/);
      alert(match);
      alert(match[1]);
      if (match && match[1]) {
        pdfUrl = 'https://drive.google.com/uc?export=download&id=${'+match[1]+'}';
      }
      alert(pdfUrl);
    }

    // --- OneDrive link conversion ---
    // Typical OneDrive shared link pattern:
    // https://onedrive.live.com/view.aspx?resid=ABC123...  or
    // https://1drv.ms/b/s!ABC123...
    if (pdfUrl.includes('1drv.ms') || pdfUrl.includes('onedrive.live.com')) {
      // Make it embeddable
      pdfUrl = pdfUrl.replace("redir", "embed");
      pdfUrl = pdfUrl.replace("view.aspx", "embed");
      // Force PDF viewer embed mode
      if (!pdfUrl.includes("embed")) {
        pdfUrl += (pdfUrl.includes("?") ? "&" : "?") + "embed=1";
      }
    }

    // --- Display the clickable reference link ---
    linkEl.href = tpl.link;
    linkEl.textContent = `View reference for ${tpl.name}`;
    linkEl.style.display = 'inline';

    // --- Try to display PDF ---
    pdfViewer.src = pdfUrl;
    pdfContainer.style.display = 'block';

    // --- Validate MIME type (optional but cleaner) ---
    try {
      const res = await fetch(pdfUrl, { method: 'HEAD' });
      const contentType = res.headers.get('content-type') || '';
      if (!contentType.includes('pdf')) {
        // If it's not a PDF or fetch fails, hide the frame
        pdfContainer.style.display = 'none';
        pdfViewer.src = '';
      }
    } catch(e) {
      pdfContainer.style.display = 'none';
      pdfViewer.src = '';
      alert("An error occurred:", e.message);
    }
  }
});

  
formatBtn.addEventListener('click', ()=>{
  const out = formatReportFromInput(inputText.value || '');
  outputEl.textContent = out || '(no output)';
});

copyBtn.addEventListener('click', async ()=>{
  const text = outputEl.textContent;
  if(!text) return alert('Nothing to copy');
  try{
    await navigator.clipboard.writeText(text);
    alert('Copied to clipboard');
  }catch(e){ alert('Copy failed: ' + e.message); }
});

downloadBtn.addEventListener('click', ()=>{
  const text = outputEl.textContent;
  if(!text) return alert('Nothing to download');
  const blob = new Blob([text], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'Formatted_Report.txt';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(a.href);
});

document.addEventListener("DOMContentLoaded", () => {
  const url = document.getElementById('csvUrl').value;
  if (url) fetchAndLoadCSV(url);
});

</script>
</body>
</html>
